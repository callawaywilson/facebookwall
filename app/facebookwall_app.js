// Facebook Wall
// author: Adam Wilson
//  adam@hugecity.us
FacebookWall={},function(){var e={urlRoot:"https://graph.facebook.com",url:function(){return this.urlRoot+"/"+this.id},sync:function(e,t,n){n.data||(n.data={}),n.data=_.extend(n.data,{access_token:this.session().accessToken});var r=n.success,i=n.error;return n=_.extend(n,{success:function(e,t,n){if(t.error){if(!i)throw"Unhandled Error: "+JSON.stringify(t);i(e,t,n)}else r&&r(e,t,n)}}),this._limit&&!n.data.limit&&(n.data.limit=this._limit),n.dataType="jsonp",Backbone.sync(e,t,n)},linkify:function(e){var t=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,n=/(^|[^\/])(www\.[-A-Z0-9+&@#\/%?=~_|!:,.;]+(\b|$))/gi,r=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gi,i=e.replace(t,'<a href="$1" target="_blank">$1</a>');return i=i.replace(n,'$1<a href="http://$2" target="_blank">$2</a>'),i=i.replace(r,'<a href="mailto:$1">$1</a>'),i},formatDateTime:function(e){var t=moment(e),n=43200,r=3600,i=60,s=moment().unix()-t.unix();if(s<i)return"seconds ago";if(s<r){var o=Math.floor(s/60);return o+(o==1?" minute ago":" minutes ago")}if(s<n){var o=Math.floor(s/60/60);return o+(o==1?" hour ago":" hours ago")}return t.format("ddd MMM Do [at] h:mm a")},fbPicUrl:function(e,t){var n=t||"large";return"https://graph.facebook.com/"+e+"/picture?type="+n},fbUrl:function(e){return"https://www.facebook.com/"+(e||this.get("id"))}};FacebookWall.Collection=Backbone.Collection.extend(_.extend(e,{paging:{},_defaults:{limit:50},parse:function(e){return this.paging=e.paging||{},e.data},hasNext:function(){return!!this.paging.next},fetchNext:function(){this.paging.next&&Backbone.sync("read",this,{url:this.paging.next,dataType:"jsonp",success:function(e,t,n){e.add(e.parse(t)),e.trigger("fetchedNext")}})}})),FacebookWall.Model=Backbone.Model.extend(e)}(),FacebookWall.Post=FacebookWall.Model.extend({parse:function(e){var t=[];e.commentsCount=e.comments?e.comments.count:0,e.comments&&e.comments.data&&(t=_.map(e.comments.data,function(e){return new FacebookWall.Comment(e)})),e.comments=new Backbone.Collection(t,{model:FacebookWall.Comment});var n=[];return e.likesCount=e.likes?e.likes.count:0,e.likes&&e.likes.data&&(n=_.map(e.likes.data,function(e){return new FacebookWall.Like(e)})),e.likes=new Backbone.Collection(n,{model:FacebookWall.Like}),e},fromPicUrl:function(e){return this.fbPicUrl(this.get("from").id,e)},fromUrl:function(){return this.fbUrl(this.get("from").id)},picUrl:function(e){return e=="normal"?this.get("picture").replace("_s.jpg","_q.jpg"):e=="large"?this.get("picture").replace("_s.jpg","_n.jpg"):this.get("picture")}}),FacebookWall.Comment=FacebookWall.Model.extend({fromPicUrl:function(e){return this.fbPicUrl(this.get("from").id,e)},fromUrl:function(){return this.fbUrl(this.get("from").id)}}),FacebookWall.Like=FacebookWall.Model.extend({userUrl:function(){return this.fbUrl(this.get("id"))}}),FacebookWall.Feed=FacebookWall.Collection.extend({model:FacebookWall.Post,url:function(){return this.urlRoot+"/"+this.id+"/feed"},initialize:function(e,t){if(!t||!t.session||!t.session.accessToken)throw"FacebookWall.Feed requires a session with accessToken";if(!t||!t.id)throw"FacebookWall.Feed requires an id";this.id=t.id,this.session(t.session),this._limit=t.limit||this._defaults.limit},session:function(e){return e&&(this._session=e),this._session},canPost:function(){return!0}}),FacebookWall.BaseView=Backbone.View.extend({}),FacebookWall.FeedView=FacebookWall.BaseView.extend({className:"_fbw-feed",template:_.template('<div class="_fbw-loading" style="display:none">Loading Posts...</div><div class="_fbw-empty" style="display:none">No posts</div><div class="_fbw-post-container" style="display:none"><textarea class="fbw-post-textarea" placeholder="Write a post.."></textarea><div class="fbw-post-feed-controls" style="display:none"><button class="btn btn-success post-feed-button">Post</button><button class="btn btn-success disabled posting-feed-button" style="display:none"><img class="fb_spinner"></img>Posting</button></div></div><ul class="_fbw-post-list"></ul><div class="_fbw-load-container"><button class="_fbw-load-segment">Load more posts</button><button class="_fbw-loading-segment" disabled="true" style="display:none">Loading posts</button></div>'),events:{"focusin ._fbw-post-textarea":"showPostControls","click ._fbw-load-segment":"loadNext"},initialize:function(e){return this.feed=e.feed,this.feed.on("reset",this.reset,this),this.feed.on("add",this.add,this),this.feed.on("fetchedNext",this.updateLoadButton,this),this},render:function(){return this.$el.html(this.template(this.feed)),this.feed.each(this.add,this),this.updateLoadButton(),this},reset:function(){this.$el.find("._fbw-post-list").empty(),this.feed.each(this.add,this)},add:function(e){var t=new FacebookWall.PostView({post:e});this.$el.find("._fbw-post-list").append(t.render().el)},loadNext:function(){this.feed.fetchNext(),this.updateLoadingButton()},updateLoadingButton:function(){this.$el.find("._fbw-loading-segment").show(),this.$el.find("._fbw-load-segment").hide()},updateLoadButton:function(){this.$el.find("._fbw-loading-segment").hide(),this.$el.find("._fbw-load-segment").show();var e=this.$el.find("._fbw-load-container");this.feed.hasNext()?e.show():e.hide()},updatePost:function(){var e=this.$el.find("._fbw-post-container");this.feed.canPost()?e.show():e.hide()},showEmpty:function(){this.$el.find("._fbw-empty").show()},showPostControls:function(){this.$el.find("._fbw-post-textarea").addClass("focused"),this.$el.find("._fbw-post-feed-controls").show()}}),FacebookWall.PostView=FacebookWall.BaseView.extend({maxLikes:4,tagName:"li",className:"_fbw-post",template:_.template('<div class="_fbw-post-header"><img src="<%= fromPicUrl("square") %>"></img><div class="_fbw-post-from"><a href="<%= fromUrl() %>"><%= get("from").name %></a></div><div class="_fbw-post-from-details"><%= formatDateTime(get("created_time")) %></div></div><div class="_fbw-post-content"><% if (get("message")) {%><%= linkify(get("message")) %><% } %></div><div class="_fbw-post-footer"><div class="_fbw-post-controls"><div class="_fbw-post-controls-commands"><span class="_fbw-post-link">Like</span> &sdot; <span class="_fbw-post-link">Comment</span></div><div class="_fbw-post-controls-views"><% if (get("likesCount") > 0) { %><span class="_fbw-show-likes _fbw-post-link"><%= get("likesCount") %> Like<%if (get("likesCount") != 1) { %>s<%}%></span>  <% } %><% if (get("commentsCount") > 0) { %>&nbsp;<span class="_fbw-show-comments _fbw-post-link"><%= get("commentsCount") %> Comment<%if (get("commentsCount") != 1) { %>s<%}%></span><% } %></div><div style="clear:both;"></div></div><div class="_fbw-likes" style="display:none;"></div><ul class="_fbw-comments" style="display:none;"></ul><div class="_fbw-comments-comment" style="display:none;"><table border="0" cellpadding="0" cellspacing="0"><tr><td width="100%"><input class="_fbw-comments-comment-input"></input></td><td width="1%"><button class="_fbw-comments-comment-post">Post</button></td></tr></table></div></div></div>'),templateLink:_.template('<div class="_fbw-post-type-link"><a href="<%= get("link") %>" target="_blank"><img class="_fbw-post-link-picture" src="<%= get("picture") %>"></img></a><div class="_fbw-post-link-name"><a href="<%= get("link") %>" target="_blank"><%= get("name") %></a></div><div class="_fbw-post-link-caption"><%= get("caption") %></div><div class="_fbw-post-link-description"><%= get("description") %></div><div style="clear:both;"></div></div>'),templatePhoto:_.template('<div class="_fbw-post-type-photo"><img src="<%= picUrl("normal") %>"></img></div>'),events:{"click ._fbw-show-comments":"showComments","click ._fbw-show-likes":"showLikes","click ._fbw-show-reply":"showReply","click ._fbw-post-type-photo img":"loadLargePicture"},initialize:function(e){return this.post=e.post,this},render:function(){this.$el.html(this.template(this.post));var e=$(this.el).find("._fbw-post-content");return this.post.get("type")=="link"?e.append(this.templateLink(this.post)):this.post.get("type")=="photo"?e.append(this.templatePhoto(this.post)):this.post.get("type")=="video"&&e.append(this.templateLink(this.post)),this},loadLargePicture:function(){var e=this.post.picUrl("large");this.$el.find("._fbw-post-type-photo img").attr("src",e)},showReply:function(){this.$el.find(".fbw-post-reply").show()},showLikes:function(){var e=this.post.get("likesCount"),t=this.post.get("likes").models,n=this.post.get("likes").length,r=this.$el.find("._fbw-likes"),i="";for(var s=0;s<n&&s<this.maxLikes;s++)i+='<a href="'+t[s].userUrl()+'">'+t[s].get("name")+"</a>",s==n-2&&n==e?i+=" and ":s<n-1&&(i+=", ");if(e>this.maxLikes){var o=e-n;o==1?i+=" and 1 other person likes this":i+=", and "+o+" other people like this"}else t.length==1?i+=" likes this":i+=" like this";r.html(i),r.show()},showComment:function(){},showComments:function(){this.showReply(),this.$el.find("._fbw-comments").empty(),this.$el.find("._fbw-comments").show(),console.log(this.post.get("comments")),this.post.get("comments").each(this.addComment,this)},addComment:function(e){var t=new FacebookWall.CommentView({comment:e});this.$el.find("._fbw-comments").append(t.render().el)}}),FacebookWall.CommentView=FacebookWall.BaseView.extend({tagName:"li",template:_.template('<img src="<%= fromPicUrl("square") %>"></img><div class="_fbw-comment-from"><a href="<%= fromUrl() %>"><%= get("from").name %></a></div><div class="_fbw-comment-content"><%= get("message") %></div> <div class="_fbw-comment-controls"><span class="_fbw-comment-time"><%= formatDateTime(get("created_time")) %> &sdot;</span> <a href="#">Like</a></div>'),initialize:function(e){return this.comment=e.comment,this},render:function(e){return this.$el.html(this.template(this.comment)),this}});