FacebookWall={},function(){var t={urlRoot:"https://graph.facebook.com",url:function(){return this.urlRoot+"/"+this.id},urlLike:function(){return this.url()+"/likes"},urlComment:function(){return this.url()+"/comments"},sync:function(t,e,s){s.data||(s.data={}),s.data=_.extend(s.data,{access_token:this.session().accessToken});var i=s.success,o=s.error;return s=_.extend(s,{success:function(t,e,s){if(e.error){if(!o)throw"Unhandled Error: "+JSON.stringify(e);o(t,e,s)}else i&&(t.fetched=!0,i(t,e,s))}}),this._limit&&!s.data.limit&&(s.data.limit=this._limit),s.dataType="jsonp",Backbone.sync(t,e,s)},linkify:function(t){var e=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,s=/(^|[^\/])(www\.[-A-Z0-9+&@#\/%?=~_|!:,.;]+(\b|$))/gi,i=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gi,o=t.replace(e,'<a href="$1" target="_blank">$1</a>');return o=o.replace(s,'$1<a href="http://$2" target="_blank">$2</a>'),o=o.replace(i,'<a href="mailto:$1">$1</a>')},formatDateTime:function(t){var e=moment(t),s=43200,i=3600,o=60,n=moment().unix()-e.unix();if(o>n)return"seconds ago";if(i>n){var a=Math.floor(n/60);return a+(1==a?" minute ago":" minutes ago")}if(s>n){var a=Math.floor(n/60/60);return a+(1==a?" hour ago":" hours ago")}return e.format("ddd MMM Do [at] h:mm a")}};FacebookWall.Collection=Backbone.Collection.extend(_.extend({},t,{paging:{},_defaults:{limit:50},session:function(t){return t&&(this._session=t),this._session},parse:function(t){return this.paging=t.paging||{},t.data},hasNext:function(){return!!this.paging.next},fetchNext:function(){this.paging.next&&Backbone.sync("read",this,{url:this.paging.next,dataType:"jsonp",success:function(t,e){_.each(t.parse(e),function(e){t.add(new t.model(e,{parse:!0}))}),t.trigger("fetchedNext")}})}})),FacebookWall.Model=Backbone.Model.extend(_.extend({},t,{fbPicUrl:function(t,e){var s=e||"large";return"https://graph.facebook.com/"+t+"/picture?type="+s},fbUrl:function(t){return"https://www.facebook.com/"+(t||this.get("id"))},session:function(t){return this.collection?this.collection.session(t):(t&&(this._session=t),this._session)},fromPicUrl:function(t){return this.fbPicUrl(this.get("from").id,t)},fromUrl:function(){return this.fbUrl(this.get("from").id)},picUrl:function(t){return"normal"==t?this.get("picture").replace("_s.jpg","_q.jpg"):"large"==t?this.get("picture").replace("_s.jpg","_n.jpg"):this.get("picture")},fbLike:function(t){return $.ajax({url:this.urlLike(),dataType:"jsonp",data:{method:"unlike"==t.type?"delete":"post",access_token:this.session().accessToken},success:t.success,error:t.error})},fbComment:function(t){return $.ajax({url:this.urlComment(),dataType:"jsonp",data:{method:"delete"==t.type?"delete":"post",access_token:this.session().accessToken,message:t.message},success:t.success,error:t.error})}}))}(),FacebookWall.Post=FacebookWall.Model.extend({parse:function(t){var e=[];t.commentsCount=t.comments?t.comments.count:0,t.comments&&t.comments.data&&(e=_.map(t.comments.data,function(t){return new FacebookWall.Comment(t)})),t.comments=new FacebookWall.Collection(e,{model:FacebookWall.Comment}),t.comments.session(this.session());var s=[];return t.likesCount=t.likes?t.likes.count:0,t.likes&&t.likes.data&&(s=_.map(t.likes.data,function(t){return new FacebookWall.Like(t)})),t.likes=new FacebookWall.Collection(s,{model:FacebookWall.Like}),t.likes.session(this.session()),t},isLiked:function(){var t=this.session().userID;return t?this.get("likes").some(function(e){return t==e.get("id")}):!1},comment:function(t){var e=this;this.fbComment({type:"post",message:t,success:function(s){s.id&&(e.get("comments").push(new FacebookWall.Comment({id:s.id,from:{name:"You",id:e.session().userID},message:t,created_time:new Date})),e.set("commentsCount",e.get("commentsCount")+1))},error:function(){}})},like:function(){var t=this;this.fbLike({type:"like",success:function(){t.set("likesCount",t.get("likesCount")+1),t.get("likes").unshift({name:"You",id:t.session().userID})}})},unlike:function(){var t=this;this.fbLike({type:"unlike",success:function(){var e=t.get("likes"),s=e.filter(function(e){return e.get("id")==t.session().userID});t.set("likesCount",t.get("likesCount")-s.length),e.remove(s)}})}}),FacebookWall.Comment=FacebookWall.Model.extend({name:function(){return this.isMe()?"You":this.get("from").name},isMe:function(){return this.session()&&this.session().userID==this.get("from").id},like:function(){var t=this;this.fbLike({type:"like",success:function(){t.set("user_likes",!0)}})},unlike:function(){var t=this;this.fbLike({type:"unlike",success:function(){t.set("user_likes",!1)}})}}),FacebookWall.Like=FacebookWall.Model.extend({userUrl:function(){return this.fbUrl(this.get("id"))},name:function(){return this.isMe()?"You":this.get("name")},isMe:function(){return this.session()&&this.session().userID==this.get("id")}}),FacebookWall.Feed=FacebookWall.Collection.extend({model:FacebookWall.Post,url:function(){return this.urlRoot+"/"+this.id+"/feed"},initialize:function(t,e){if(!(e&&e.session&&e.session.accessToken&&e.session.userID))throw"FacebookWall.Feed requires a session with accessToken and userID";if(!e||!e.id)throw"FacebookWall.Feed requires an id";return this.id=e.id,this.can_post=e.can_post,this.session(e.session),this._limit=e.limit||this._defaults.limit,this},canPost:function(){return this.can_post}}),FacebookWall.BaseView=Backbone.View.extend({}),FacebookWall.FeedView=FacebookWall.BaseView.extend({className:"fbw-feed",template:_.template('<div class="fbw-loading" style="display:none"></div><div class="fbw-empty" style="display:none">No posts</div><div class="fbw-post-container" style="display:none"><textarea class="fbw-post-textarea" placeholder="Write a post.."></textarea><div class="fbw-post-feed-controls" style="display:none"><button class="btn btn-success post-feed-button">Post</button><button class="btn btn-success disabled posting-feed-button" style="display:none"><img class="fb_spinner"></img>Posting</button></div></div><ul class="fbw-post-list"></ul><div class="fbw-load-container"><button class="fbw-load-segment">Load more posts</button><button class="fbw-loading-segment" disabled="true" style="display:none">Loading posts</button></div>'),events:{"focusin .fbw-post-textarea":"showPostControls","click .fbw-load-segment":"loadNext"},initialize:function(t){return this.feed=t.feed,this.feed.on("reset",this.reset,this),this.feed.on("add",this.add,this),this.feed.on("fetchedNext",this.updateLoadButton,this),this},render:function(){return this.$el.html(this.template(this.feed)),this.feed.each(this.add,this),this.fetched?1>this.feed.size()&&this.showEmpty():this.showLoading(),this.updateLoadButton(),this},reset:function(){this.$el.find(".fbw-loading").hide(),this.$el.find(".fbw-empty").hide(),this.$el.find(".fbw-post-list").empty(),1>this.feed.size()?this.showEmpty():(this.feed.each(this.add,this),this.updateLoadButton())},add:function(t){var e=new FacebookWall.PostView({post:t});this.$el.find(".fbw-post-list").append(e.render().el)},loadNext:function(){this.feed.fetchNext(),this.updateLoadingButton()},updateLoadingButton:function(){this.$el.find(".fbw-loading-segment").show(),this.$el.find(".fbw-load-segment").hide()},updateLoadButton:function(){this.$el.find(".fbw-loading-segment").hide(),this.$el.find(".fbw-load-segment").show();var t=this.$el.find(".fbw-load-container");this.feed.hasNext()?t.show():t.hide()},updatePost:function(){var t=this.$el.find(".fbw-post-container");this.feed.canPost()?t.show():t.hide()},showLoading:function(){this.$el.find(".fbw-loading").show(),this.$el.find(".fbw-loading").html("Loading Posts<br/>"),this.$el.find(".fbw-loading").append((new FacebookWall.Spinner).render().el),this.$el.find(".fbw-empty").hide()},showEmpty:function(){this.$el.find(".fbw-loading").hide(),this.$el.find(".fbw-empty").show()},showPostControls:function(){this.$el.find(".fbw-post-textarea").addClass("focused"),this.$el.find(".fbw-post-feed-controls").show()}}),FacebookWall.PostView=FacebookWall.BaseView.extend({maxLikes:4,tagName:"li",className:"fbw-post",showingLikes:!1,showingComments:!1,template:_.template('<div class="fbw-post-header"><img src="<%= fromPicUrl("square") %>"></img><div class="fbw-post-from"><a href="<%= fromUrl() %>"><%= get("from").name %></a></div><div class="fbw-post-from-details"><%= formatDateTime(get("created_time")) %></div></div><div class="fbw-post-content"><% if (get("message")) {%><%= linkify(get("message")) %><% } %></div><div class="fbw-post-footer"><div class="fbw-post-controls"><div class="fbw-post-controls-commands"><span class="fbw-post-link fbw-btn-like-post"></span> &sdot; <span class="fbw-post-link fbw-btn-comment-post">Comment</span></div><div class="fbw-post-controls-views"><% if (get("likesCount") > 0) { %><a href="javascript:void(0)" class="fbw-show-likes fbw-post-link"><%= get("likesCount") %> Like<%if (get("likesCount") != 1) { %>s<%}%></a>  <% } %><% if (get("commentsCount") > 0) { %>&nbsp;<a href="javascript:void(0)" class="fbw-show-comments fbw-post-link"><%= get("commentsCount") %> Comment<%if (get("commentsCount") != 1) { %>s<%}%></a><% } %></div><div style="clear:both;"></div></div><div class="fbw-likes" style="display:none;"></div><ul class="fbw-comments" style="display:none;"></ul><div class="fbw-comments-comment" style="display:none;"><form class="fbw-comments-comment-form"><table border="0" cellpadding="0" cellspacing="0"><tr><td width="100%"><input class="fbw-comments-comment-input"></input></td><td width="1%"><button class="fbw-comments-comment-post" type="submit">Post</button></td></tr></table></form></div></div></div>'),templateLink:_.template('<div class="fbw-post-type-link"><a href="<%= get("link") %>" target="_blank"><img class="fbw-post-link-picture" src="<%= get("picture") %>"></img></a><div class="fbw-post-link-name"><a href="<%= get("link") %>" target="_blank"><%= get("name") %></a></div><div class="fbw-post-link-caption"><%= get("caption") %></div><div class="fbw-post-link-description"><%= get("description") %></div><div style="clear:both;"></div></div>'),templatePhoto:_.template('<div class="fbw-post-type-photo"><img class="fbw-thumbnail" src="<%= picUrl("normal") %>"></img></div>'),events:{"click .fbw-show-comments":"toggleComments","click .fbw-show-likes":"showLikes","click .fbw-post-type-photo img":"loadLargePicture","click .fbw-btn-like-post":"like","click .fbw-btn-comment-post":"showComment","submit .fbw-comments-comment-form":"comment"},initialize:function(t){return this.post=t.post,this.post.get("likes").on("all",this.render,this),this.post.get("comments").on("all",this.render,this),this},render:function(){this.$el.html(this.template(this.post));var t=this.$(".fbw-post-content");return"link"==this.post.get("type")?t.append(this.templateLink(this.post)):"photo"==this.post.get("type")?t.append(this.templatePhoto(this.post)):"video"==this.post.get("type")&&t.append(this.templateLink(this.post)),this.showingLikes&&this.showLikes(),this.showingComments&&this.showComments(),this.renderLikeButton(),this},renderLikeButton:function(){this.$(".fbw-btn-like-post").html(this.post.isLiked()?"Unlike":"Like")},loadLargePicture:function(){var t=this.post.picUrl("large");this.$(".fbw-post-type-photo .fbw-thumbnail").attr("src",t),this.$(".fbw-post-type-photo .fbw-thumbnail").removeClass("fbw-thumbnail")},like:function(){this.post.isLiked()?this.post.unlike():this.post.like()},showLikes:function(){if(this.showingLikes)this.showingLikes=!1,this.$(".fbw-likes").hide();else{this.showingLikes=!0;var t=this.post.get("likesCount"),e=this.post.get("likes").models,s=this.post.get("likes").length;if(1>s)return;for(var i=this.$(".fbw-likes"),o="",n=0;s>n&&this.maxLikes>n;n++)o+='<a href="'+e[n].fbUrl()+'">'+e[n].name()+"</a>",n==s-2&&s==t?o+=" and ":s-1>n&&(o+=", ");if(t>this.maxLikes){var a=t-s;o+=1==a?" and 1 other person likes this":", and "+a+" other people like this"}else o+=1!=e.length||e[0].isMe()?" like this":" likes this";i.html(o),i.show()}},showComment:function(){this.showingComments||this.showComments(),this.$(".fbw-comments-comment-input").focus()},toggleComments:function(){this.showingComments?this.hideComments():this.showComments()},showComments:function(){this.showingComments=!0,this.$(".fbw-comments").empty(),this.$(".fbw-comments").show(),this.post.get("comments").each(this.addComment,this),this.$(".fbw-comments-comment").show(),this.$(".fbw-comments-comment-post").removeAttr("disabled")},hideComments:function(){this.showingComments=!1,this.$(".fbw-comments").hide(),this.$(".fbw-comments-comment").hide()},addComment:function(t){var e=new FacebookWall.CommentView({comment:t});this.$(".fbw-comments").append(e.render().el)},comment:function(t){t.preventDefault();try{var e=this.$(".fbw-comments-comment-input").val();e&&!/^\s*$/.test(e)&&(this.$(".fbw-comments-comment-post").attr("disabled",!0),this.post.comment(e))}catch(s){console.log(s)}return!1}}),FacebookWall.CommentView=FacebookWall.BaseView.extend({tagName:"li",template:_.template('<img src="<%= fromPicUrl("square") %>"></img><div class="fbw-comment-from"><a href="<%= fromUrl() %>"><%= name() %></a></div><div class="fbw-comment-content"><%= get("message") %></div> <div class="fbw-comment-controls"><span class="fbw-comment-time"><%= formatDateTime(get("created_time")) %></span> </div>'),events:{"click .fbw-comment-like":"like","click .fbw-comment-unlike":"unlike"},initialize:function(t){return this.comment=t.comment,this.comment.on("change",this.render,this),this},render:function(){return this.$el.html(this.template(this.comment)),this},like:function(){this.comment.like()},unlike:function(){this.comment.unlike()}}),FacebookWall.Spinner=Backbone.View.extend({className:"fbw-spinner ",render:function(){return this.$el.html('<div class="fbw-bar1"></div><div class="fbw-bar2"></div><div class="fbw-bar3"></div><div class="fbw-bar4"></div><div class="fbw-bar5"></div><div class="fbw-bar6"></div><div class="fbw-bar7"></div><div class="fbw-bar8"></div><div class="fbw-bar9"></div><div class="fbw-bar10"></div><div class="fbw-bar11"></div><div class="fbw-bar12"></div>'),this}});